# Implementation Plan: Thesis-Refine Orchestrator

**Branch**: `002-thesis-refine-orchestrator` | **Date**: 2026-02-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-thesis-refine-orchestrator/spec.md`

## Summary

Create a new skill `thesis-refine-with-latex` that serves as a specialized orchestrator for LaTeX thesis revision. This skill coordinates `latex-guard`, `academic-polisher`, and `humanizer` with support for long document chunking, self-healing placeholder recovery, ambiguous feedback clarification, and comprehensive change logging.

The existing `thesis-pipeline` skill remains unchanged as a lightweight generic orchestrator, allowing future expansion for non-LaTeX content (e.g., plain text, Word documents).

## Technical Context

**Language/Version**: Markdown (Cursor Agent Skill) - prompt engineering  
**Primary Dependencies**: Existing skills (`latex-guard`, `academic-polisher`, `humanizer`)  
**Storage**: N/A (in-memory processing per invocation)  
**Testing**: Manual testing with sample LaTeX chapters  
**Target Platform**: Cursor IDE Agent  
**Project Type**: Single skill with references  
**Performance Goals**: Single paragraph <30s, full chapter <5 minutes  
**Constraints**: Must preserve 100% of LaTeX structural elements  
**Scale/Scope**: Chapters up to 20,000 tokens

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution file contains template placeholders - no specific gates defined. Proceeding with standard skill development practices:

- [x] Skill must be self-contained and independently testable
- [x] Clear documentation and usage examples required
- [x] No external dependencies beyond existing skills

## Project Structure

### Documentation (this feature)

```text
specs/002-thesis-refine-orchestrator/
├── plan.md              # This file
├── research.md          # Chunking and feedback matching strategies
├── data-model.md        # Entity definitions for orchestrator
├── quickstart.md        # Usage guide
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
.cursor/skills/
├── thesis-pipeline/                    # UNCHANGED - generic orchestrator
│   ├── SKILL.md
│   └── references/
│       ├── humanizer-integration.md
│       └── terminology-template.md
│
└── thesis-refine-with-latex/           # NEW - LaTeX-specific orchestrator
    ├── SKILL.md                        # Main skill definition
    └── references/
        ├── chunking-strategy.md        # Long document handling
        ├── feedback-matching.md        # Clarification logic
        ├── change-log-format.md        # Output structure
        └── self-healing.md             # Placeholder recovery
```

**Structure Decision**: Create new skill `thesis-refine-with-latex` as a specialized LaTeX orchestrator. Keep `thesis-pipeline` as-is for potential future non-LaTeX use cases (plain text, Word documents). This provides clean separation:

| Skill | Purpose | Future Use |
|-------|---------|------------|
| `thesis-pipeline` | Generic thesis processing workflow | Non-LaTeX content |
| `thesis-refine-with-latex` | LaTeX-specific refinement with chunking, self-healing | LaTeX thesis chapters |
| `latex-guard` | LaTeX element protection | Called by thesis-refine-with-latex |
| `academic-polisher` | Academic style improvements | Both orchestrators |
| `humanizer` | AI pattern reduction | Both orchestrators |

## Skill Architecture

```
                        ┌─────────────────────────────┐
                        │    User Request             │
                        │ (LaTeX + Supervisor Feedback)│
                        └─────────────┬───────────────┘
                                      │
                                      ▼
                        ┌─────────────────────────────┐
                        │  thesis-refine-with-latex   │
                        │  (NEW LaTeX Orchestrator)   │
                        └─────────────┬───────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   latex-guard   │       │academic-polisher│       │    humanizer    │
│  (mask/unmask)  │       │ (formal style)  │       │ (AI reduction)  │
└─────────────────┘       └─────────────────┘       └─────────────────┘
```

## Implementation Approach

### Phase 1: Create New Skill Structure

1. **Create `thesis-refine-with-latex/SKILL.md`**
   - Define skill metadata and triggers
   - Document complete processing workflow
   - Include explicit mask → process → unmask flow
   - Add validation step after unmask to verify structural integrity

2. **Create Reference Files**
   - `chunking-strategy.md`: Section-based splitting with context overlap
   - `feedback-matching.md`: Keyword overlap algorithm and clarification mode
   - `change-log-format.md`: Structured output format
   - `self-healing.md`: Placeholder verification and recovery

### Phase 2: Core Processing Logic

3. **Chunking Strategy**
   - Split by LaTeX section boundaries (`\section{}`, `\subsection{}`)
   - Fallback to paragraph boundaries if sections exceed 8K tokens
   - Preserve context window overlap (500 tokens) between chunks
   - Validate chunk boundaries don't break LaTeX environments

4. **Self-Healing Mechanism**
   - After humanizer, verify all placeholders are intact
   - If missing, attempt recovery from original masked content
   - Use context matching to find insertion position
   - Log any recovered placeholders in change log

### Phase 3: Feedback Processing

5. **Ambiguous Feedback Detection**
   - Score feedback-to-content match using keyword overlap
   - If match <30%, enumerate candidate paragraphs for user selection
   - Present top 3 candidates with match scores
   - Store user selection for session consistency

6. **Change Log Generation**
   - Track: original text, modified text, modification type, skill source
   - Correlate changes with supervisor feedback items
   - Output structured format for user review

### Phase 4: Quality Assurance

7. **AI Score Estimation**
   - After processing, sample output text for AI pattern density
   - Report estimated score based on humanizer pattern reduction
   - Warn if score likely exceeds 10% threshold

## Skill Triggers

The new skill should trigger on:

```yaml
triggers:
  - "thesis refine with latex"
  - "latex thesis revision"
  - "revise latex chapter"
  - "process latex with supervisor feedback"
  - requests containing both ".tex" file and supervisor comments
  - requests mentioning "protect citations" + "improve academic style"
```

## Complexity Tracking

No constitution violations - creating new skill follows standard patterns.

## Dependencies

| Skill | Version | Required Capability |
|-------|---------|---------------------|
| latex-guard | current | Mask/unmask LaTeX elements |
| academic-polisher | current | Formal academic style |
| humanizer | 2.1.1 | AI pattern reduction |

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Chunking breaks LaTeX environments | Split only at safe boundaries; validate post-reassembly |
| Placeholder loss during humanizer | Self-healing recovery; preserve original for rollback |
| False positives in ambiguous feedback | Conservative 30% threshold; always offer manual override |
| Skill trigger overlap with thesis-pipeline | Clear trigger differentiation; LaTeX indicators required |

## Migration Notes

- `thesis-pipeline` remains unchanged - no breaking changes
- Users can continue using `thesis-pipeline` for simple cases
- `thesis-refine-with-latex` provides enhanced LaTeX-specific features
- Future: May create `thesis-refine-with-text` for non-LaTeX content
